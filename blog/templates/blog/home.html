{% extends 'base.html' %}
{% block content %}
{% load custom_tags %}
{% load static %}
{% load time_blog %}
{% block header_title %}
FotoBlog
{% endblock %}



<!-- CSS spécifique à la page -->
<link rel="stylesheet" href="{% static 'css/home.css' %}">


<div class="button-container">
    {% if user.is_authenticated %}
        {% if perms.blog.add_blog %}
            <a href="{% url 'create_blog_post' %}" class="btn-create">Créer un billet</a>
            <a href="{% url 'photo_upload' %}" class="btn-upload">Une photo</a>
        {% else %}
            <a href="{% url 'follow_users' %}" class="btn-create">Suivre des créateurs</a>
            <a href="{% url 'photo_upload' %}" class="btn-upload">Une photo</a>
        {% endif %}
    {% else %}
        <a href="{% url 'login' %}" class="btn-create">Se connecter</a>
        <a href="{% url 'signup' %}" class="btn-upload">S'inscrire</a>
    {% endif %}
</div>

<div id="feed-container" class="photo-gallery" data-initial-offset="{{ photos|length }}">
    {% for photo in photos %}
        {% with photo.blog_set.all|first as related_blog %}
        <div class="photo-card-wrapper" data-photo-id="{{ photo.id }}">
            <div class="photo-card">
                <div class="photo-image-container">
                    <img src="{{ photo.image.url }}" alt="{{ photo.caption }}">
                    <div class="user-info-overlay">
                        <div class="profile-photo small">
                            {% if photo.uploader.profile_photo %}
                                <img src="{{ photo.uploader.profile_photo.url }}" alt="{{ photo.uploader.username }}">
                            {% else %}
                                <img src="{% static 'icons/user-light-full.svg' %}" alt="Photo par défaut">
                            {% endif %}
                        </div>
                        <div class="details small">
    <p class="uploader-line">
        <!-- Lien vers le profil utilisateur -->
        <a href="{% url 'user-profile' username=photo.uploader.username %}" class="profile-link">
            {{ photo.uploader.username }}
        </a>

        {% if photo.uploader.role == 'Creator' %}
            <svg class="creator-badge" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="Creator badge">
                <defs>
                    <linearGradient id="gCreator" x1="0" x2="1" y1="0" y2="1">
                        <stop offset="0" stop-color="#3AB0FF"/>
                        <stop offset="1" stop-color="#1DA1F2"/>
                    </linearGradient>
                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                        <feDropShadow dx="0" dy="1.5" stdDeviation="2" flood-color="#0b76c9" flood-opacity="0.35"/>
                    </filter>
                </defs>
                <circle cx="12" cy="12" r="11.2" fill="url(#gCreator)" filter="url(#shadow)" />
                <path d="M8.6 12.2 L11 14.6 L15.6 9.8" fill="none" stroke="#fff" stroke-width="2.2"/>
            </svg>
        {% endif %}
    </p>
    <div class="date small">{{ photo.date_created|facebook_time }}</div>
</div></div>
                </div>
                <div class="photo-info">
                    <p class="caption">
                        {% if related_blog %}
                            <a href="{% url 'view_blog' related_blog.id %}" class="photo-card-link">
                                {{ related_blog.title }} <span class="link-lire">... Lire</span>
                            </a>
                        {% else %}
                            {{ photo.caption }}
                        {% endif %}
                    </p>
                </div>

                <div class="photo-actions">
                    <div class="action comments">
                        <button class="comment-btn" title="Commenter">
                            <span class="comments-count">2K</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                        </button>
                    </div>

                    <div class="action comments">
                        <button class="comment-btn" title="Partager">
                            <span class="comments-count">5</span>
                            
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            
                        </button>
                    </div>

                    <div class="action likes">
                        <span class="likes-count">{{ photo.likes.count }}</span>
                        <button class="like-btn {% if photo_likes|dict_get:photo.id %}liked{% endif %}" title="J'aime">
                            {% if photo_likes|dict_get:photo.id %}
                                <svg class="heart-svg filled" xmlns="http://www.w3.org/2000/svg" fill="red" viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            {% else %}
                                <svg class="heart-svg empty" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="white" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09 C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endwith %}
    {% endfor %}
</div>

<div id="feed-loader" class="feed-loader" aria-hidden="true" style="display:none;"></div>

<audio id="likeSound" src="{% static 'audio/audiocutter_facebook-like-sound-effect2.mp3' %}" preload="auto" style="display:none;"></audio>

{% if user.is_authenticated and not user.profile_photo %}
<div id="profileModal" class="modal">
  <div class="modal-content">
    <h2>Vous n'avez pas de photo de profil</h2>
    <form method="post" enctype="multipart/form-data" action="{% url 'update_profile_photo' %}">
      {% csrf_token %}
      <<input type="file" name="profile_photo" id="profilePhotoInput" accept="image/*" required style="display:none">

      <div id="previewContainer" class="preview-container">
        <div class="preview-user-info">
          <div class="profile-photo preview-photo">
            <img id="currentPhoto" src="{% static 'icons/default_profile.png' %}" alt="Photo par défaut">
            <img id="previewImage" src="#" alt="Aperçu" class="hidden">
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" id="importBtn" class="btn">Importer</button>
        <button type="submit" class="btn primary">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Styles internes pour l'overlay et badge créateur -->
<style>

</style>

<!-- JS spécifique à la page -->
<script src="{% static 'js/home.js' %}" defer></script>

{% endblock content %}